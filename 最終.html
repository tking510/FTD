<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ポイント交換プラットフォーム - ほぼ完璧版</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-gold: #FFD700;
            --light-gold: #FFFACD;
            --dark-gold: #DAA520;
        }
        .bg-primary-gold { background-color: var(--primary-gold); }
        .bg-light-gold { background-color: var(--light-gold); }
        .text-primary-gold { color: var(--primary-gold); }
        .border-primary-gold { border-color: var(--primary-gold); }
        .hover\:bg-primary-gold:hover { background-color: var(--primary-gold); }
        .tab-active { background-color: var(--primary-gold); color: white; }
        .tab-inactive { background-color: #f7fafc; color: var(--primary-gold); }
        .hidden { display: none !important; }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover { color: black; }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <!-- ログイン画面 -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-yellow-50 to-orange-50">
        <div class="bg-white p-8 rounded-lg shadow-lg w-96">
            <div class="text-center mb-6">
                <i class="fas fa-coins text-primary-gold text-5xl mb-4"></i>
                <h1 class="text-2xl font-bold text-gray-800">ポイント交換プラットフォーム</h1>
                <p class="text-gray-600 text-sm">1円 = 1PT</p>
            </div>
            <form onsubmit="login(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ユーザー名</label>
                    <input type="text" id="loginUsername" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">パスワード</label>
                    <input type="password" id="loginPassword" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent" required>
                </div>
                <button type="submit" class="w-full bg-primary-gold text-white p-3 rounded-lg hover:bg-primary-gold transition duration-200">
                    <i class="fas fa-sign-in-alt mr-2"></i>ログイン
                </button>
            </form>
            <div class="mt-6 text-center text-sm text-gray-500">
                <p>最低購入: 2,000円 | 最低換金: 4,000円</p>
            </div>
        </div>
    </div>

    <!-- 管理画面 -->
    <div id="adminScreen" class="hidden">
        <!-- ヘッダー -->
        <nav class="bg-primary-gold shadow-lg">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <i class="fas fa-coins text-white text-2xl mr-3"></i>
                        <span class="text-white text-xl font-bold">管理画面</span>
                    </div>
                    <button onclick="logout()" class="text-white hover:text-gray-200">
                        <i class="fas fa-sign-out-alt mr-2"></i>ログアウト
                    </button>
                </div>
            </div>
        </nav>

        <div class="flex">
            <!-- サイドバー -->
            <div class="w-64 bg-white shadow-lg min-h-screen">
                <div class="p-4">
                    <button onclick="showTab('applications')" class="tab-button w-full text-left py-3 px-4 mb-2 rounded-lg tab-active">
                        <i class="fas fa-list mr-3"></i>申請管理
                    </button>
                    <button onclick="showTab('users')" class="tab-button w-full text-left py-3 px-4 mb-2 rounded-lg tab-inactive">
                        <i class="fas fa-users mr-3"></i>ユーザー管理
                    </button>
                    <button onclick="showTab('payments')" class="tab-button w-full text-left py-3 px-4 mb-2 rounded-lg tab-inactive">
                        <i class="fas fa-credit-card mr-3"></i>決済設定
                    </button>
                    <button onclick="showTab('notifications')" class="tab-button w-full text-left py-3 px-4 mb-2 rounded-lg tab-inactive">
                        <i class="fas fa-bell mr-3"></i>通知設定
                    </button>
                </div>
            </div>

            <!-- メインコンテンツ -->
            <div class="flex-1 p-6">
                <!-- 申請管理タブ -->
                <div id="applications" class="tab-content">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-bold mb-6">申請管理</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ユーザー</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">種類</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">金額</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ステータス</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日時</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="applicationsTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- 申請データがここに表示されます -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ユーザー管理タブ -->
                <div id="users" class="tab-content hidden">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-bold mb-6">ユーザー管理</h2>
                        
                        <!-- 個別ユーザー作成 -->
                        <div class="mb-8 p-4 bg-blue-50 rounded-lg">
                            <h3 class="text-lg font-semibold mb-4">個別ユーザー作成</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ユーザー名</label>
                                    <input type="text" id="newUsername" class="w-full p-3 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">パスワード</label>
                                    <input type="password" id="newPassword" class="w-full p-3 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                            <button onclick="createUser()" class="mt-4 bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600">
                                <i class="fas fa-plus mr-2"></i>ユーザー作成
                            </button>
                        </div>

                        <!-- CSV一括インポート -->
                        <div class="mb-8 p-4 bg-green-50 rounded-lg">
                            <h3 class="text-lg font-semibold mb-4">CSV一括インポート</h3>
                            <p class="text-sm text-gray-600 mb-3">CSVファイル形式：username,password (ヘッダー行は不要)</p>
                            <input type="file" id="csvFile" accept=".csv" class="mb-3">
                            <button onclick="importCSV()" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600">
                                <i class="fas fa-upload mr-2"></i>CSV インポート
                            </button>
                        </div>

                        <!-- ユーザー一覧 -->
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ユーザー名</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">役割</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">作成日時</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- ユーザーデータがここに表示されます -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 決済設定タブ -->
                <div id="payments" class="tab-content hidden">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-bold mb-6">決済方法設定</h2>
                        
                        <!-- PayPay設定 -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold mb-4">PayPay設定</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">PayPay ID</label>
                                    <input type="text" id="paypayId" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="PayPay IDを入力">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">PayPay URL</label>
                                    <input type="text" id="paypayUrl" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="PayPay URLを入力">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">PayPay QRコード</label>
                                    <input type="file" id="paypayQR" accept="image/*" class="w-full p-3 border border-gray-300 rounded-lg">
                                    <div id="paypayQRPreview" class="mt-2"></div>
                                </div>
                                <button onclick="savePayPaySettings()" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600">
                                    <i class="fas fa-save mr-2"></i>PayPay設定を保存
                                </button>
                            </div>
                        </div>

                        <!-- 仮想通貨設定 -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold mb-4">仮想通貨設定</h3>
                            <div class="space-y-4" id="cryptoSettings">
                                <div class="crypto-setting p-4 border border-gray-200 rounded-lg">
                                    <div class="grid grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">通貨名</label>
                                            <input type="text" class="crypto-name w-full p-3 border border-gray-300 rounded-lg" placeholder="例: Bitcoin">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">シンボル</label>
                                            <input type="text" class="crypto-symbol w-full p-3 border border-gray-300 rounded-lg" placeholder="例: BTC">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">ウォレットアドレス</label>
                                            <input type="text" class="crypto-address w-full p-3 border border-gray-300 rounded-lg" placeholder="ウォレットアドレスを入力">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">ネットワーク</label>
                                            <input type="text" class="crypto-network w-full p-3 border border-gray-300 rounded-lg" placeholder="例: ERC-20">
                                        </div>
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">タグ (XRP用等)</label>
                                        <input type="text" class="crypto-tag w-full p-3 border border-gray-300 rounded-lg" placeholder="タグがある場合は入力">
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">QRコード</label>
                                        <input type="file" class="crypto-qr w-full p-3 border border-gray-300 rounded-lg" accept="image/*">
                                        <div class="crypto-qr-preview mt-2"></div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button onclick="removeCryptoSetting(this)" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">削除</button>
                                    </div>
                                </div>
                            </div>
                            <div class="flex space-x-4 mt-4">
                                <button onclick="addCryptoSetting()" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600">
                                    <i class="fas fa-plus mr-2"></i>仮想通貨を追加
                                </button>
                                <button onclick="saveCryptoSettings()" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600">
                                    <i class="fas fa-save mr-2"></i>仮想通貨設定を保存
                                </button>
                            </div>
                        </div>

                        <!-- 銀行設定 -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold mb-4">銀行設定</h3>
                            
                            <!-- 個人銀行設定 -->
                            <div class="mb-6 p-4 border border-gray-200 rounded-lg">
                                <h4 class="font-medium mb-4">個人銀行</h4>
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">銀行名</label>
                                        <input type="text" id="personalBankName" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="銀行名を入力">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">支店名</label>
                                        <input type="text" id="personalBranchName" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="支店名を入力">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">口座番号</label>
                                        <input type="text" id="personalAccountNumber" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="口座番号を入力">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">口座名義</label>
                                        <input type="text" id="personalAccountName" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="口座名義を入力">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">最低金額</label>
                                        <input type="number" id="personalMinAmount" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="最低金額">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">最高金額</label>
                                        <input type="number" id="personalMaxAmount" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="最高金額">
                                    </div>
                                </div>
                                <button onclick="savePersonalBankSettings()" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600">
                                    <i class="fas fa-save mr-2"></i>個人銀行設定を保存
                                </button>
                            </div>

                            <!-- 法人銀行設定 -->
                            <div class="mb-6 p-4 border border-gray-200 rounded-lg">
                                <h4 class="font-medium mb-4">法人銀行</h4>
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">銀行名</label>
                                        <input type="text" id="corporateBankName" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="銀行名を入力">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">支店名</label>
                                        <input type="text" id="corporateBranchName" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="支店名を入力">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">口座番号</label>
                                        <input type="text" id="corporateAccountNumber" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="口座番号を入力">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">口座名義</label>
                                        <input type="text" id="corporateAccountName" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="口座名義を入力">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">最低金額</label>
                                        <input type="number" id="corporateMinAmount" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="最低金額">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">最高金額</label>
                                        <input type="number" id="corporateMaxAmount" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="最高金額">
                                    </div>
                                </div>
                                <button onclick="saveCorporateBankSettings()" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600">
                                    <i class="fas fa-save mr-2"></i>法人銀行設定を保存
                                </button>
                            </div>
                        </div>

                        <!-- コンビニ設定 -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold mb-4">コンビニ設定</h3>
                            <div id="convenienceSettings" class="space-y-4">
                                <!-- コンビニ設定がここに表示されます -->
                            </div>
                            <div class="flex space-x-4 mt-4">
                                <button onclick="addConvenienceSetting()" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600">
                                    <i class="fas fa-plus mr-2"></i>コンビニを追加
                                </button>
                                <button onclick="saveConvenienceSettings()" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600">
                                    <i class="fas fa-save mr-2"></i>コンビニ設定を保存
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 通知設定タブ -->
                <div id="notifications" class="tab-content hidden">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-bold mb-6">Telegram通知設定</h2>
                        
                        <!-- 購入通知設定 -->
                        <div class="mb-8 p-4 border border-gray-200 rounded-lg">
                            <h3 class="text-lg font-semibold mb-4">購入通知設定</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Bot Token</label>
                                    <input type="text" id="purchaseBotToken" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Telegram Bot Tokenを入力">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Chat ID</label>
                                    <input type="text" id="purchaseChatId" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Chat IDを入力">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Thread ID</label>
                                    <input type="text" id="purchaseThreadId" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Thread IDを入力（任意）">
                                </div>
                            </div>
                        </div>

                        <!-- 換金通知設定 -->
                        <div class="mb-8 p-4 border border-gray-200 rounded-lg">
                            <h3 class="text-lg font-semibold mb-4">換金通知設定</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Bot Token</label>
                                    <input type="text" id="cashoutBotToken" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Telegram Bot Tokenを入力">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Chat ID</label>
                                    <input type="text" id="cashoutChatId" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Chat IDを入力">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Thread ID</label>
                                    <input type="text" id="cashoutThreadId" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Thread IDを入力（任意）">
                                </div>
                            </div>
                        </div>

                        <button onclick="saveTelegramSettings()" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600">
                            <i class="fas fa-save mr-2"></i>通知設定を保存
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ユーザー画面 -->
    <div id="userScreen" class="hidden">
        <!-- ヘッダー -->
        <nav class="bg-primary-gold shadow-lg">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <i class="fas fa-coins text-white text-2xl mr-3"></i>
                        <span class="text-white text-xl font-bold">ポイント交換プラットフォーム</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-white" id="userPoints">0 PT</span>
                        <button onclick="logout()" class="text-white hover:text-gray-200">
                            <i class="fas fa-sign-out-alt mr-2"></i>ログアウト
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-4xl mx-auto p-6">
            <!-- タブナビゲーション -->
            <div class="flex border-b border-gray-200 mb-6">
                <button onclick="showUserTab('purchase')" class="user-tab-button py-4 px-6 font-medium border-b-2 border-primary-gold text-primary-gold">
                    <i class="fas fa-shopping-cart mr-2"></i>ポイント購入
                </button>
                <button onclick="showUserTab('cashout')" class="user-tab-button py-4 px-6 font-medium border-b-2 border-transparent hover:text-primary-gold">
                    <i class="fas fa-money-bill-wave mr-2"></i>ポイント換金
                </button>
                <button onclick="showUserTab('withdrawal-info')" class="user-tab-button py-4 px-6 font-medium border-b-2 border-transparent hover:text-primary-gold">
                    <i class="fas fa-wallet mr-2"></i>出金先情報
                </button>
                <button onclick="showUserTab('history')" class="user-tab-button py-4 px-6 font-medium border-b-2 border-transparent hover:text-primary-gold">
                    <i class="fas fa-history mr-2"></i>履歴
                </button>
            </div>

            <!-- ポイント購入タブ -->
            <div id="user-purchase" class="user-tab-content">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-6">ポイント購入申請</h2>
                    <form onsubmit="submitPurchaseApplication(event)" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">購入金額（円）</label>
                            <input type="number" id="purchaseAmount" min="2000" class="w-full p-3 border border-gray-300 rounded-lg" required placeholder="最低2,000円">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">決済ジャンル</label>
                            <select id="purchaseGenre" class="w-full p-3 border border-gray-300 rounded-lg" onchange="showPurchaseMethodOptions()">
                                <option value="">選択してください</option>
                                <option value="paypay">PayPay</option>
                                <option value="crypto">仮想通貨</option>
                                <option value="bank">銀行振込</option>
                                <option value="convenience">コンビニ決済</option>
                            </select>
                        </div>
                        <div id="purchaseMethodContainer" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">詳細選択</label>
                            <select id="purchaseMethod" class="w-full p-3 border border-gray-300 rounded-lg" onchange="showPurchasePaymentInfo()">
                                <option value="">選択してください</option>
                            </select>
                        </div>
                        <div id="purchasePaymentInfo" class="hidden">
                            <!-- 決済情報が表示される -->
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">入金証明画像</label>
                            <input type="file" id="purchaseProof" accept="image/*" class="w-full p-3 border border-gray-300 rounded-lg">
                            <div id="purchaseProofPreview" class="mt-2"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">取引URL</label>
                            <textarea id="purchaseMemo" rows="3" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="取引URLがあれば入力してください"></textarea>
                        </div>
                        <button type="submit" id="purchaseSubmitBtn" class="w-full bg-primary-gold text-white py-3 rounded-lg hover:bg-primary-gold">
                            <i class="fas fa-paper-plane mr-2"></i>購入申請を送信
                        </button>
                    </form>
                </div>
            </div>

            <!-- ポイント換金タブ -->
            <div id="user-cashout" class="user-tab-content hidden">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-6">ポイント換金申請</h2>
                    <form onsubmit="submitCashoutApplication(event)" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">換金金額（円）</label>
                            <input type="number" id="cashoutAmount" min="4000" class="w-full p-3 border border-gray-300 rounded-lg" required placeholder="最低4,000円">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">出金方法</label>
                            <select id="cashoutMethod" class="w-full p-3 border border-gray-300 rounded-lg" onchange="showCashoutOptions()">
                                <option value="">選択してください</option>
                                <option value="paypay">PayPay</option>
                                <option value="crypto">仮想通貨</option>
                                <option value="bank">銀行振込</option>
                            </select>
                        </div>
                        <div id="cashoutDetailsContainer" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">出金先選択</label>
                            <select id="cashoutDetails" class="w-full p-3 border border-gray-300 rounded-lg">
                                <option value="">選択してください</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">メモ（任意）</label>
                            <textarea id="cashoutMemo" rows="3" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="申請に関するメモがあれば入力してください"></textarea>
                        </div>
                        <button type="submit" class="w-full bg-primary-gold text-white py-3 rounded-lg hover:bg-primary-gold">
                            <i class="fas fa-paper-plane mr-2"></i>換金申請を送信
                        </button>
                    </form>
                </div>
            </div>

            <!-- 出金先情報タブ -->
            <div id="user-withdrawal-info" class="user-tab-content hidden">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-6">出金先情報登録</h2>

                    <!-- PayPay出金先 -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4">PayPay出金先</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">PayPay URL</label>
                                <input type="text" id="userPaypayUrl" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="PayPay URLを入力（任意）">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">PayPay ID</label>
                                <input type="text" id="userPaypayId" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="PayPay IDを入力（任意）">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">名義</label>
                                <input type="text" id="userPaypayName" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="名義を入力（任意）">
                            </div>
                            <button onclick="saveUserPaypayInfo()" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600">
                                <i class="fas fa-save mr-2"></i>PayPay情報を保存
                            </button>
                        </div>
                    </div>

                    <!-- 仮想通貨出金先 -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4">仮想通貨出金先</h3>
                        <div id="userCryptoList" class="space-y-4 mb-4">
                            <!-- 登録済み仮想通貨がここに表示されます -->
                        </div>
                        <div class="space-y-4 p-4 border border-gray-200 rounded-lg">
                            <div class="space-y-3">
                                <select id="userCryptoType" class="w-full p-3 border border-gray-300 rounded-lg">
                                    <option value="">選択してください</option>
                                    <option value="BTC">Bitcoin (BTC)</option>
                                    <option value="ETH">Ethereum (ETH)</option>
                                    <option value="USDT">Tether (USDT)</option>
                                    <option value="custom">カスタム通貨を追加...</option>
                                </select>
                                
                                <!-- カスタム通貨追加フォーム -->
                                <div id="customCryptoForm" class="hidden bg-gray-50 p-4 rounded-lg">
                                    <h4 class="font-medium mb-3">新しい仮想通貨を追加</h4>
                                    <div class="grid grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">通貨名</label>
                                            <input type="text" id="customCryptoName" class="w-full p-2 border border-gray-300 rounded" placeholder="例: Ripple">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">シンボル</label>
                                            <input type="text" id="customCryptoSymbol" class="w-full p-2 border border-gray-300 rounded" placeholder="例: XRP">
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button type="button" onclick="addCustomCrypto()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                                            追加
                                        </button>
                                        <button type="button" onclick="cancelCustomCrypto()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                                            キャンセル
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ウォレットアドレス</label>
                                <input type="text" id="userCryptoAddress" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ウォレットアドレスを入力">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ネットワーク</label>
                                <input type="text" id="userCryptoNetwork" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="例: ERC-20, TRC-20">
                            </div>
                            <button onclick="saveUserCryptoInfo()" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600">
                                <i class="fas fa-save mr-2"></i>仮想通貨出金先を追加
                            </button>
                        </div>
                    </div>

                    <!-- 銀行出金先 -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4">銀行出金先</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">銀行名</label>
                                <input type="text" id="userBankName" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="銀行名を入力">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">支店名</label>
                                <input type="text" id="userBranchName" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="支店名を入力">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">口座番号</label>
                                <input type="text" id="userAccountNumber" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="口座番号を入力">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">口座名義</label>
                                <input type="text" id="userAccountName" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="口座名義を入力">
                            </div>
                            <button onclick="saveUserBankInfo()" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600">
                                <i class="fas fa-save mr-2"></i>銀行情報を保存
                            </button>
                        </div>
                    </div>

                    <!-- 登録済み出金先情報表示 -->
                    <div id="withdrawalInfoDisplay" class="mt-8">
                        <h3 class="text-lg font-semibold mb-4">登録済み出金先情報</h3>
                        <div id="withdrawalInfoContent">
                            <!-- 登録済み情報がここに表示されます -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 履歴タブ -->
            <div id="user-history" class="user-tab-content hidden">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-6">申請履歴</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">種類</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">金額</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ステータス</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">申請日時</th>
                                </tr>
                            </thead>
                            <tbody id="userHistoryTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- 履歴データがここに表示されます -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let currentUser = null;
        let currentRole = null;
        let applications = [];
        let users = [];
        let paymentMethods = {
            paypay: { id: '', url: '', qr: '' },
            crypto: [],
            bank: { personal: {}, corporate: {} },
            convenience: []
        };
        let notificationSettings = {
            purchase: { token: '', chatId: '', threadId: '' },
            cashout: { token: '', chatId: '', threadId: '' }
        };
        let userWithdrawals = {};
        let currentPurchaseId = null;

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            initializeScreen();
        });

        // データ読み込み
        function loadData() {
            users = JSON.parse(localStorage.getItem('users') || '[]');
            applications = JSON.parse(localStorage.getItem('applications') || '[]');
            paymentMethods = JSON.parse(localStorage.getItem('paymentMethods') || '{"paypay":{"id":"","url":"","qr":""},"crypto":[],"bank":{"personal":{},"corporate":{}},"convenience":[]}');
            notificationSettings = JSON.parse(localStorage.getItem('notificationSettings') || '{"purchase":{"token":"","chatId":"","threadId":""},"cashout":{"token":"","chatId":"","threadId":""}}');
            userWithdrawals = JSON.parse(localStorage.getItem('userWithdrawals') || '{}');
            
            // 管理者ユーザーが存在しない場合は作成
            if (!users.find(u => u.username === 'admin')) {
                users.push({
                    username: 'admin',
                    password: 'admin123',
                    role: 'admin',
                    createdAt: new Date().toISOString()
                });
                saveData();
            }
        }

        // データ保存
        function saveData() {
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('applications', JSON.stringify(applications));
            localStorage.setItem('paymentMethods', JSON.stringify(paymentMethods));
            localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));
            localStorage.setItem('userWithdrawals', JSON.stringify(userWithdrawals));
        }

        // 画面初期化
        function initializeScreen() {
            const hash = window.location.hash;
            if (hash === '#user') {
                showUserLogin();
            }
        }

        function showUserLogin() {
            // ユーザーログイン用の表示調整は不要（同じログイン画面を使用）
        }

        // ログイン処理
        function login(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                currentRole = user.role;
                
                if (user.role === 'admin') {
                    showAdminScreen();
                } else {
                    showUserScreen();
                }
            } else {
                alert('ログインに失敗しました。ユーザー名またはパスワードが間違っています。');
            }
        }

        // ログアウト処理
        function logout() {
            currentUser = null;
            currentRole = null;
            document.getElementById('adminScreen').classList.add('hidden');
            document.getElementById('userScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            // フォームをリセット
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }

        // 管理画面表示
        function showAdminScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('adminScreen').classList.remove('hidden');
            loadApplicationsTable();
            loadUsersTable();
            loadPaymentSettings();
            loadTelegramSettings();
        }

        // ユーザー画面表示
        function showUserScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('userScreen').classList.remove('hidden');
            updateUserPoints();
            loadUserHistory();
            loadUserWithdrawalInfo();
        }

        // タブ表示制御
        function showTab(tabName) {
            // タブボタンの状態更新
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                if (button.onclick.toString().includes(tabName)) {
                    button.className = 'tab-button w-full text-left py-3 px-4 mb-2 rounded-lg tab-active';
                } else {
                    button.className = 'tab-button w-full text-left py-3 px-4 mb-2 rounded-lg tab-inactive';
                }
            });

            // タブコンテンツの表示制御
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tabName).classList.remove('hidden');

            // タブ切り替え時の処理
            if (tabName === 'applications') {
                loadApplicationsTable();
            } else if (tabName === 'users') {
                loadUsersTable();
            } else if (tabName === 'payments') {
                loadPaymentSettings();
            } else if (tabName === 'notifications') {
                loadTelegramSettings();
            }
        }

        // ユーザータブ表示制御
        function showUserTab(tabName) {
            // タブボタンの状態更新
            const tabButtons = document.querySelectorAll('.user-tab-button');
            tabButtons.forEach(button => {
                button.className = 'user-tab-button py-4 px-6 font-medium border-b-2 border-transparent hover:text-primary-gold';
            });
            event.target.className = 'user-tab-button py-4 px-6 font-medium border-b-2 border-primary-gold text-primary-gold';

            // タブコンテンツの表示制御
            const tabContents = document.querySelectorAll('.user-tab-content');
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById('user-' + tabName).classList.remove('hidden');

            // タブ切り替え時の処理
            if (tabName === 'history') {
                loadUserHistory();
            } else if (tabName === 'withdrawal-info') {
                loadUserWithdrawalInfo();
            }
        }

        // 申請管理
        function loadApplicationsTable() {
            const tbody = document.getElementById('applicationsTableBody');
            tbody.innerHTML = '';

            applications.forEach(app => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${app.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${app.username}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${app.type === 'purchase' ? '購入' : '換金'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">¥${app.amount.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusClass(app.status)}">
                            ${getStatusText(app.status)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(app.createdAt).toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        ${app.status !== 'completed' ? `
                            <select onchange="updateApplicationStatus('${app.id}', this.value)" class="border rounded px-2 py-1">
                                <option value="pending" ${app.status === 'pending' ? 'selected' : ''}>申請中</option>
                                <option value="processing" ${app.status === 'processing' ? 'selected' : ''}>処理中</option>
                                <option value="completed" ${app.status === 'completed' ? 'selected' : ''}>完了</option>
                            </select>
                        ` : '完了済み'}
                        <button onclick="showApplicationDetails('${app.id}')" class="ml-2 text-blue-600 hover:text-blue-900">詳細</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getStatusClass(status) {
            switch(status) {
                case 'pending': return 'bg-yellow-100 text-yellow-800';
                case 'processing': return 'bg-blue-100 text-blue-800';
                case 'completed': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'pending': return '申請中';
                case 'processing': return '処理中';
                case 'completed': return '完了';
                default: return '不明';
            }
        }

        function updateApplicationStatus(appId, newStatus) {
            const app = applications.find(a => a.id === appId);
            if (app) {
                app.status = newStatus;
                saveData();
                loadApplicationsTable();
            }
        }

        function showApplicationDetails(appId) {
            const app = applications.find(a => a.id === appId);
            if (app) {
                let details = `申請詳細\n\nID: ${app.id}\nユーザー: ${app.username}\n種類: ${app.type === 'purchase' ? '購入' : '換金'}\n金額: ¥${app.amount.toLocaleString()}\nステータス: ${getStatusText(app.status)}\n申請日時: ${new Date(app.createdAt).toLocaleString()}`;
                
                if (app.method) details += `\n決済方法: ${app.method}`;
                if (app.memo) details += `\n取引URL: ${app.memo}`;
                
                alert(details);
            }
        }

        // ユーザー管理
        function loadUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.username}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.role === 'admin' ? '管理者' : 'ユーザー'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(user.createdAt).toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        ${user.role !== 'admin' ? `<button onclick="deleteUser('${user.username}')" class="text-red-600 hover:text-red-900">削除</button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function createUser() {
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;

            if (!username || !password) {
                alert('ユーザー名とパスワードを入力してください');
                return;
            }

            if (users.find(u => u.username === username)) {
                alert('このユーザー名は既に存在します');
                return;
            }

            users.push({
                username: username,
                password: password,
                role: 'user',
                createdAt: new Date().toISOString()
            });

            saveData();
            loadUsersTable();
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            alert('ユーザーを作成しました');
        }

        function deleteUser(username) {
            if (confirm(`ユーザー「${username}」を削除しますか？`)) {
                users = users.filter(u => u.username !== username);
                saveData();
                loadUsersTable();
            }
        }

        function importCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('CSVファイルを選択してください');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n');
                let imported = 0;
                let errors = [];

                lines.forEach((line, index) => {
                    if (line.trim()) {
                        const [username, password] = line.split(',').map(s => s.trim());
                        
                        if (username && password) {
                            if (!users.find(u => u.username === username)) {
                                users.push({
                                    username: username,
                                    password: password,
                                    role: 'user',
                                    createdAt: new Date().toISOString()
                                });
                                imported++;
                            } else {
                                errors.push(`行${index + 1}: ユーザー名「${username}」は既に存在します`);
                            }
                        } else {
                            errors.push(`行${index + 1}: ユーザー名またはパスワードが不正です`);
                        }
                    }
                });

                saveData();
                loadUsersTable();
                
                let message = `${imported}件のユーザーをインポートしました`;
                if (errors.length > 0) {
                    message += `\n\nエラー:\n${errors.join('\n')}`;
                }
                alert(message);
                
                fileInput.value = '';
            };
            reader.readAsText(file);
        }

        // 決済設定
        function loadPaymentSettings() {
            // PayPay設定
            document.getElementById('paypayId').value = paymentMethods.paypay.id || '';
            document.getElementById('paypayUrl').value = paymentMethods.paypay.url || '';
            
            // 銀行設定
            if (paymentMethods.bank.personal) {
                document.getElementById('personalBankName').value = paymentMethods.bank.personal.bankName || '';
                document.getElementById('personalBranchName').value = paymentMethods.bank.personal.branchName || '';
                document.getElementById('personalAccountNumber').value = paymentMethods.bank.personal.accountNumber || '';
                document.getElementById('personalAccountName').value = paymentMethods.bank.personal.accountName || '';
                document.getElementById('personalMinAmount').value = paymentMethods.bank.personal.minAmount || '';
                document.getElementById('personalMaxAmount').value = paymentMethods.bank.personal.maxAmount || '';
            }
            
            if (paymentMethods.bank.corporate) {
                document.getElementById('corporateBankName').value = paymentMethods.bank.corporate.bankName || '';
                document.getElementById('corporateBranchName').value = paymentMethods.bank.corporate.branchName || '';
                document.getElementById('corporateAccountNumber').value = paymentMethods.bank.corporate.accountNumber || '';
                document.getElementById('corporateAccountName').value = paymentMethods.bank.corporate.accountName || '';
                document.getElementById('corporateMinAmount').value = paymentMethods.bank.corporate.minAmount || '';
                document.getElementById('corporateMaxAmount').value = paymentMethods.bank.corporate.maxAmount || '';
            }

            // 仮想通貨設定
            loadCryptoSettings();
            
            // コンビニ設定
            loadConvenienceSettings();
        }

        function savePayPaySettings() {
            paymentMethods.paypay.id = document.getElementById('paypayId').value;
            paymentMethods.paypay.url = document.getElementById('paypayUrl').value;
            
            const qrFile = document.getElementById('paypayQR').files[0];
            if (qrFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    paymentMethods.paypay.qr = e.target.result;
                    saveData();
                    alert('PayPay設定を保存しました');
                };
                reader.readAsDataURL(qrFile);
            } else {
                saveData();
                alert('PayPay設定を保存しました');
            }
        }

        function savePersonalBankSettings() {
            paymentMethods.bank.personal = {
                bankName: document.getElementById('personalBankName').value,
                branchName: document.getElementById('personalBranchName').value,
                accountNumber: document.getElementById('personalAccountNumber').value,
                accountName: document.getElementById('personalAccountName').value,
                minAmount: document.getElementById('personalMinAmount').value,
                maxAmount: document.getElementById('personalMaxAmount').value
            };
            saveData();
            alert('個人銀行設定を保存しました');
        }

        function saveCorporateBankSettings() {
            paymentMethods.bank.corporate = {
                bankName: document.getElementById('corporateBankName').value,
                branchName: document.getElementById('corporateBranchName').value,
                accountNumber: document.getElementById('corporateAccountNumber').value,
                accountName: document.getElementById('corporateAccountName').value,
                minAmount: document.getElementById('corporateMinAmount').value,
                maxAmount: document.getElementById('corporateMaxAmount').value
            };
            saveData();
            alert('法人銀行設定を保存しました');
        }

        function loadCryptoSettings() {
            const container = document.getElementById('cryptoSettings');
            container.innerHTML = '';

            if (paymentMethods.crypto.length === 0) {
                addCryptoSetting();
                return;
            }

            paymentMethods.crypto.forEach((crypto, index) => {
                const div = document.createElement('div');
                div.className = 'crypto-setting p-4 border border-gray-200 rounded-lg';
                div.innerHTML = `
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">通貨名</label>
                            <input type="text" class="crypto-name w-full p-3 border border-gray-300 rounded-lg" value="${crypto.name || ''}" placeholder="例: Bitcoin">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">シンボル</label>
                            <input type="text" class="crypto-symbol w-full p-3 border border-gray-300 rounded-lg" value="${crypto.symbol || ''}" placeholder="例: BTC">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ウォレットアドレス</label>
                            <input type="text" class="crypto-address w-full p-3 border border-gray-300 rounded-lg" value="${crypto.address || ''}" placeholder="ウォレットアドレスを入力">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ネットワーク</label>
                            <input type="text" class="crypto-network w-full p-3 border border-gray-300 rounded-lg" value="${crypto.network || ''}" placeholder="例: ERC-20">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">タグ (XRP用等)</label>
                        <input type="text" class="crypto-tag w-full p-3 border border-gray-300 rounded-lg" value="${crypto.tag || ''}" placeholder="タグがある場合は入力">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">QRコード</label>
                        <input type="file" class="crypto-qr w-full p-3 border border-gray-300 rounded-lg" accept="image/*">
                        <div class="crypto-qr-preview mt-2">${crypto.qr ? `<img src="${crypto.qr}" class="max-w-xs border rounded">` : ''}</div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="removeCryptoSetting(this)" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">削除</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function addCryptoSetting() {
            const container = document.getElementById('cryptoSettings');
            const div = document.createElement('div');
            div.className = 'crypto-setting p-4 border border-gray-200 rounded-lg';
            div.innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">通貨名</label>
                        <input type="text" class="crypto-name w-full p-3 border border-gray-300 rounded-lg" placeholder="例: Bitcoin">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">シンボル</label>
                        <input type="text" class="crypto-symbol w-full p-3 border border-gray-300 rounded-lg" placeholder="例: BTC">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ウォレットアドレス</label>
                        <input type="text" class="crypto-address w-full p-3 border border-gray-300 rounded-lg" placeholder="ウォレットアドレスを入力">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ネットワーク</label>
                        <input type="text" class="crypto-network w-full p-3 border border-gray-300 rounded-lg" placeholder="例: ERC-20">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">タグ (XRP用等)</label>
                    <input type="text" class="crypto-tag w-full p-3 border border-gray-300 rounded-lg" placeholder="タグがある場合は入力">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">QRコード</label>
                    <input type="file" class="crypto-qr w-full p-3 border border-gray-300 rounded-lg" accept="image/*">
                    <div class="crypto-qr-preview mt-2"></div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="removeCryptoSetting(this)" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">削除</button>
                </div>
            `;
            container.appendChild(div);
        }

        function removeCryptoSetting(button) {
            button.closest('.crypto-setting').remove();
        }

        function saveCryptoSettings() {
            const settings = document.querySelectorAll('.crypto-setting');
            paymentMethods.crypto = [];

            const promises = [];

            settings.forEach(setting => {
                const name = setting.querySelector('.crypto-name').value;
                const symbol = setting.querySelector('.crypto-symbol').value;
                const address = setting.querySelector('.crypto-address').value;
                const network = setting.querySelector('.crypto-network').value;
                const tag = setting.querySelector('.crypto-tag').value;
                const qrFile = setting.querySelector('.crypto-qr').files[0];

                if (name && symbol && address) {
                    const cryptoData = {
                        name: name,
                        symbol: symbol,
                        address: address,
                        network: network,
                        tag: tag
                    };

                    if (qrFile) {
                        const promise = new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                cryptoData.qr = e.target.result;
                                resolve(cryptoData);
                            };
                            reader.readAsDataURL(qrFile);
                        });
                        promises.push(promise);
                    } else {
                        // 既存のQR画像があるかチェック
                        const existingQR = setting.querySelector('.crypto-qr-preview img');
                        if (existingQR) {
                            cryptoData.qr = existingQR.src;
                        }
                        promises.push(Promise.resolve(cryptoData));
                    }
                }
            });

            Promise.all(promises).then(cryptoArray => {
                paymentMethods.crypto = cryptoArray;
                saveData();
                alert('仮想通貨設定を保存しました');
            });
        }

        function loadConvenienceSettings() {
            const container = document.getElementById('convenienceSettings');
            container.innerHTML = '';

            if (!paymentMethods.convenience) {
                paymentMethods.convenience = [];
            }

            paymentMethods.convenience.forEach((convenience, index) => {
                addConvenienceSettingElement(convenience);
            });
        }

        function addConvenienceSetting() {
            addConvenienceSettingElement({});
        }

        function addConvenienceSettingElement(convenience = {}) {
            const container = document.getElementById('convenienceSettings');
            const div = document.createElement('div');
            div.className = 'convenience-setting p-4 border border-gray-200 rounded-lg';
            div.innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">コンビニ名</label>
                        <input type="text" class="convenience-name w-full p-3 border border-gray-300 rounded-lg" value="${convenience.name || ''}" placeholder="例: セブンイレブン">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">表示</label>
                        <select class="convenience-visible w-full p-3 border border-gray-300 rounded-lg">
                            <option value="true" ${convenience.visible !== false ? 'selected' : ''}>表示</option>
                            <option value="false" ${convenience.visible === false ? 'selected' : ''}>非表示</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">支払い方法説明</label>
                    <textarea class="convenience-description w-full p-3 border border-gray-300 rounded-lg" rows="3" placeholder="支払い方法の詳細説明を入力">${convenience.description || ''}</textarea>
                </div>
                <div class="flex space-x-2">
                    <button onclick="removeConvenienceSetting(this)" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">削除</button>
                </div>
            `;
            container.appendChild(div);
        }

        function removeConvenienceSetting(button) {
            button.closest('.convenience-setting').remove();
        }

        function saveConvenienceSettings() {
            const settings = document.querySelectorAll('.convenience-setting');
            paymentMethods.convenience = [];

            settings.forEach(setting => {
                const name = setting.querySelector('.convenience-name').value;
                const visible = setting.querySelector('.convenience-visible').value === 'true';
                const description = setting.querySelector('.convenience-description').value;

                if (name) {
                    paymentMethods.convenience.push({
                        name: name,
                        visible: visible,
                        description: description
                    });
                }
            });

            saveData();
            alert('コンビニ設定を保存しました');
            console.log('Saved convenience settings:', paymentMethods.convenience);
        }

        // Telegram設定
        function loadTelegramSettings() {
            document.getElementById('purchaseBotToken').value = notificationSettings.purchase.token || '';
            document.getElementById('purchaseChatId').value = notificationSettings.purchase.chatId || '';
            document.getElementById('purchaseThreadId').value = notificationSettings.purchase.threadId || '';
            
            document.getElementById('cashoutBotToken').value = notificationSettings.cashout.token || '';
            document.getElementById('cashoutChatId').value = notificationSettings.cashout.chatId || '';
            document.getElementById('cashoutThreadId').value = notificationSettings.cashout.threadId || '';
        }

        function saveTelegramSettings() {
            notificationSettings.purchase = {
                token: document.getElementById('purchaseBotToken').value,
                chatId: document.getElementById('purchaseChatId').value,
                threadId: document.getElementById('purchaseThreadId').value
            };
            
            notificationSettings.cashout = {
                token: document.getElementById('cashoutBotToken').value,
                chatId: document.getElementById('cashoutChatId').value,
                threadId: document.getElementById('cashoutThreadId').value
            };
            
            saveData();
            alert('Telegram設定を保存しました');
        }

        // ユーザー側機能

        function updateUserPoints() {
            // ポイント計算ロジック（実装は簡略化）
            const completedPurchases = applications.filter(app => 
                app.username === currentUser.username && 
                app.type === 'purchase' && 
                app.status === 'completed'
            );
            const completedCashouts = applications.filter(app => 
                app.username === currentUser.username && 
                app.type === 'cashout' && 
                app.status === 'completed'
            );
            
            const purchasedPoints = completedPurchases.reduce((sum, app) => sum + app.amount, 0);
            const cashedOutPoints = completedCashouts.reduce((sum, app) => sum + app.amount, 0);
            
            const currentPoints = purchasedPoints - cashedOutPoints;
            document.getElementById('userPoints').textContent = `${currentPoints.toLocaleString()} PT`;
        }

        function loadUserHistory() {
            const tbody = document.getElementById('userHistoryTableBody');
            tbody.innerHTML = '';

            const userApps = applications.filter(app => app.username === currentUser.username);
            
            userApps.forEach(app => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${app.type === 'purchase' ? '購入' : '換金'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">¥${app.amount.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusClass(app.status)}">
                            ${getStatusText(app.status)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(app.createdAt).toLocaleString()}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // 購入申請関連
        function showPurchaseMethodOptions() {
            const genre = document.getElementById('purchaseGenre').value;
            const methodContainer = document.getElementById('purchaseMethodContainer');
            const methodSelect = document.getElementById('purchaseMethod');
            
            if (genre === 'paypay') {
                // PayPayは直接情報を表示
                methodContainer.classList.add('hidden');
                showPurchasePaymentInfo();
            } else {
                methodContainer.classList.remove('hidden');
                methodSelect.innerHTML = '<option value="">選択してください</option>';
                
                if (genre === 'crypto') {
                    paymentMethods.crypto.forEach(crypto => {
                        const option = document.createElement('option');
                        option.value = crypto.symbol;
                        option.textContent = `${crypto.name} (${crypto.symbol})`;
                        methodSelect.appendChild(option);
                    });
                } else if (genre === 'bank') {
                    if (paymentMethods.bank.personal && paymentMethods.bank.personal.bankName) {
                        const option = document.createElement('option');
                        option.value = 'personal';
                        option.textContent = '個人銀行';
                        methodSelect.appendChild(option);
                    }
                    if (paymentMethods.bank.corporate && paymentMethods.bank.corporate.bankName) {
                        const option = document.createElement('option');
                        option.value = 'corporate';
                        option.textContent = '法人銀行';
                        methodSelect.appendChild(option);
                    }
                } else if (genre === 'convenience') {
                    paymentMethods.convenience.forEach(convenience => {
                        if (convenience.visible !== false) {
                            const option = document.createElement('option');
                            option.value = convenience.name;
                            option.textContent = convenience.name;
                            methodSelect.appendChild(option);
                        }
                    });
                }
            }
        }

        function showPurchasePaymentInfo() {
            const genre = document.getElementById('purchaseGenre').value;
            const method = genre === 'paypay' ? 'paypay' : document.getElementById('purchaseMethod').value;
            const container = document.getElementById('purchasePaymentInfo');
            
            if (!method) {
                container.classList.add('hidden');
                return;
            }
            
            let html = '<div class="p-6 bg-blue-50 rounded-lg">';
            html += '<h3 class="text-xl font-semibold mb-4">入金先情報</h3>';
            
            if (genre === 'paypay') {
                if (paymentMethods.paypay.id || paymentMethods.paypay.url) {
                    if (paymentMethods.paypay.id) {
                        html += `<div class="mb-4">
                            <p class="text-lg font-bold mb-2">PayPay ID</p>
                            <div class="flex items-center gap-3">
                                <span class="text-xl font-mono bg-white p-3 rounded border flex-1">${paymentMethods.paypay.id}</span>
                                <button type="button" onclick="copyToClipboard('${paymentMethods.paypay.id}')" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                    <i class="fas fa-copy"></i> コピー
                                </button>
                            </div>
                        </div>`;
                    }
                    if (paymentMethods.paypay.url) {
                        html += `<div class="mb-4">
                            <p class="text-lg font-bold mb-2">PayPay URL</p>
                            <div class="flex items-center gap-3">
                                <span class="text-xl font-mono bg-white p-3 rounded border flex-1 break-all">${paymentMethods.paypay.url}</span>
                                <button type="button" onclick="copyToClipboard('${paymentMethods.paypay.url}')" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                    <i class="fas fa-copy"></i> コピー
                                </button>
                            </div>
                        </div>`;
                    }
                    if (paymentMethods.paypay.qr) {
                        html += `<div class="mb-4"><img src="${paymentMethods.paypay.qr}" alt="PayPay QR" class="max-w-sm border rounded"></div>`;
                    }
                } else {
                    html += '<p class="text-red-600">PayPay情報が設定されていません。</p>';
                }
            } else if (genre === 'crypto') {
                const crypto = paymentMethods.crypto.find(c => c.symbol === method);
                if (crypto) {
                    html += `<div class="border-l-4 border-yellow-500 pl-4 bg-white p-4 rounded">
                        <p class="text-lg font-bold mb-2">${crypto.name} (${crypto.symbol})</p>
                        <div class="mb-3">
                            <p class="font-semibold mb-1">ウォレットアドレス</p>
                            <div class="flex items-center gap-3">
                                <span class="text-sm font-mono bg-gray-100 p-3 rounded border flex-1 break-all">${crypto.address}</span>
                                <button type="button" onclick="copyToClipboard('${crypto.address}')" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 whitespace-nowrap">
                                    <i class="fas fa-copy"></i> コピー
                                </button>
                            </div>
                        </div>
                        ${crypto.network ? `<p class="text-sm mb-2"><strong>ネットワーク:</strong> ${crypto.network}</p>` : ''}
                        ${crypto.tag ? `<p class="text-sm mb-2"><strong>タグ:</strong> ${crypto.tag}</p>` : ''}
                        ${crypto.qr ? `<img src="${crypto.qr}" alt="${crypto.symbol} QR" class="max-w-sm border rounded mt-2">` : ''}
                    </div>`;
                }
            } else if (genre === 'bank') {
                const bankData = paymentMethods.bank[method];
                if (bankData && bankData.bankName) {
                    html += `<div class="bg-white p-4 rounded border">
                        <p class="text-lg font-bold mb-2">銀行振込情報</p>
                        <div class="space-y-2">
                            <div class="flex items-center gap-3">
                                <span class="font-semibold w-20">銀行名:</span>
                                <span class="bg-gray-100 p-2 rounded flex-1">${bankData.bankName}</span>
                                <button type="button" onclick="copyToClipboard('${bankData.bankName}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="font-semibold w-20">支店名:</span>
                                <span class="bg-gray-100 p-2 rounded flex-1">${bankData.branchName}</span>
                                <button type="button" onclick="copyToClipboard('${bankData.branchName}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="font-semibold w-20">口座番号:</span>
                                <span class="bg-gray-100 p-2 rounded flex-1">${bankData.accountNumber}</span>
                                <button type="button" onclick="copyToClipboard('${bankData.accountNumber}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="font-semibold w-20">口座名義:</span>
                                <span class="bg-gray-100 p-2 rounded flex-1">${bankData.accountName}</span>
                                <button type="button" onclick="copyToClipboard('${bankData.accountName}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>`;
                }
            } else if (genre === 'convenience') {
                const convenience = paymentMethods.convenience.find(c => c.name === method);
                if (convenience) {
                    html += `<div class="bg-white p-4 rounded border">
                        <p class="text-lg font-bold mb-2">${convenience.name}</p>
                        <div class="whitespace-pre-line text-lg leading-relaxed">${convenience.description}</div>
                    </div>`;
                }
            }
            
            html += '</div>';
            container.innerHTML = html;
            container.classList.remove('hidden');

            // ボタンテキストを変更
            const submitBtn = document.getElementById('purchaseSubmitBtn');
            submitBtn.innerHTML = '<i class="fas fa-check mr-2"></i>入金完了';
        }

        function submitPurchaseApplication(event) {
            event.preventDefault();
            
            const amount = parseInt(document.getElementById('purchaseAmount').value);
            const genre = document.getElementById('purchaseGenre').value;
            const method = genre === 'paypay' ? 'paypay' : document.getElementById('purchaseMethod').value;
            const proof = document.getElementById('purchaseProof').files[0];
            const memo = document.getElementById('purchaseMemo').value;

            if (amount < 2000) {
                alert('最低購入金額は2,000円です');
                return;
            }

            if (!genre) {
                alert('決済ジャンルを選択してください');
                return;
            }

            if (genre !== 'paypay' && !method) {
                alert('詳細選択を行ってください');
                return;
            }

            const application = {
                id: 'P' + Date.now(),
                username: currentUser.username,
                type: 'purchase',
                amount: amount,
                method: method,
                memo: memo,
                status: 'completed', // 入金完了として申請
                createdAt: new Date().toISOString()
            };

            if (proof) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    application.proof = e.target.result;
                    applications.push(application);
                    saveData();
                    
                    // 入金完了時のTelegram通知
                    sendTelegramNotification('purchase', `
入金完了通知

申請ID: ${application.id}
ユーザー: ${application.username}
金額: ¥${application.amount.toLocaleString()}
決済方法: ${application.method}
${application.memo ? `取引URL: ${application.memo}` : ''}
                    `);
                    
                    alert('入金完了を報告しました');
                    event.target.reset();
                    document.getElementById('purchasePaymentInfo').classList.add('hidden');
                    document.getElementById('purchaseMethodContainer').classList.add('hidden');
                    document.getElementById('purchaseSubmitBtn').innerHTML = '<i class="fas fa-paper-plane mr-2"></i>購入申請を送信';
                    updateUserPoints();
                    loadUserHistory();
                };
                reader.readAsDataURL(proof);
            } else {
                applications.push(application);
                saveData();
                
                // 入金完了時のTelegram通知
                sendTelegramNotification('purchase', `
入金完了通知

申請ID: ${application.id}
ユーザー: ${application.username}
金額: ¥${application.amount.toLocaleString()}
決済方法: ${application.method}
${application.memo ? `取引URL: ${application.memo}` : ''}
                `);
                
                alert('入金完了を報告しました');
                event.target.reset();
                document.getElementById('purchasePaymentInfo').classList.add('hidden');
                document.getElementById('purchaseMethodContainer').classList.add('hidden');
                document.getElementById('purchaseSubmitBtn').innerHTML = '<i class="fas fa-paper-plane mr-2"></i>購入申請を送信';
                updateUserPoints();
                loadUserHistory();
            }
        }

        // 換金申請
        function showCashoutOptions() {
            const method = document.getElementById('cashoutMethod').value;
            const container = document.getElementById('cashoutDetailsContainer');
            const select = document.getElementById('cashoutDetails');
            
            if (!method) {
                container.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            select.innerHTML = '<option value="">選択してください</option>';
            
            const userWithdrawal = userWithdrawals[currentUser.username] || {};
            
            if (method === 'paypay' && userWithdrawal.paypay) {
                const option = document.createElement('option');
                option.value = 'paypay';
                option.textContent = `PayPay: ${userWithdrawal.paypay.id || userWithdrawal.paypay.url || 'PayPay出金先'}`;
                select.appendChild(option);
            } else if (method === 'crypto' && userWithdrawal.crypto) {
                userWithdrawal.crypto.forEach((crypto, index) => {
                    const option = document.createElement('option');
                    option.value = `crypto_${index}`;
                    option.textContent = `${crypto.type}: ${crypto.address.substring(0, 20)}...`;
                    select.appendChild(option);
                });
            } else if (method === 'bank' && userWithdrawal.bank) {
                const option = document.createElement('option');
                option.value = 'bank';
                option.textContent = `${userWithdrawal.bank.bankName}: ${userWithdrawal.bank.accountNumber}`;
                select.appendChild(option);
            }
        }

        function submitCashoutApplication(event) {
            event.preventDefault();
            
            const amount = parseInt(document.getElementById('cashoutAmount').value);
            const method = document.getElementById('cashoutMethod').value;
            const details = document.getElementById('cashoutDetails').value;
            const memo = document.getElementById('cashoutMemo').value;

            if (amount < 4000) {
                alert('最低換金金額は4,000円です');
                return;
            }

            if (!method || !details) {
                alert('出金方法と出金先を選択してください');
                return;
            }

            const application = {
                id: 'C' + Date.now(),
                username: currentUser.username,
                type: 'cashout',
                amount: amount,
                method: method,
                details: details,
                memo: memo,
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            applications.push(application);
            saveData();
            
            sendTelegramNotification('cashout', `
換金申請通知

申請ID: ${application.id}
ユーザー: ${application.username}
金額: ¥${application.amount.toLocaleString()}
出金方法: ${application.method}
${application.memo ? `メモ: ${application.memo}` : ''}
            `);
            
            alert('換金申請を送信しました');
            event.target.reset();
            document.getElementById('cashoutDetailsContainer').classList.add('hidden');
            updateUserPoints();
            loadUserHistory();
        }

        // 出金先情報管理
        function loadUserWithdrawalInfo() {
            const userWithdrawal = userWithdrawals[currentUser.username] || {};
            
            // PayPay情報
            if (userWithdrawal.paypay) {
                document.getElementById('userPaypayUrl').value = userWithdrawal.paypay.url || '';
                document.getElementById('userPaypayId').value = userWithdrawal.paypay.id || '';
                document.getElementById('userPaypayName').value = userWithdrawal.paypay.name || '';
            }
            
            // 銀行情報
            if (userWithdrawal.bank) {
                document.getElementById('userBankName').value = userWithdrawal.bank.bankName || '';
                document.getElementById('userBranchName').value = userWithdrawal.bank.branchName || '';
                document.getElementById('userAccountNumber').value = userWithdrawal.bank.accountNumber || '';
                document.getElementById('userAccountName').value = userWithdrawal.bank.accountName || '';
            }
            
            // 仮想通貨リスト表示
            displayUserCryptoList();
            
            // 登録済み情報表示
            displayWithdrawalInfo();
        }

        function displayUserCryptoList() {
            const container = document.getElementById('userCryptoList');
            const userWithdrawal = userWithdrawals[currentUser.username] || {};
            
            container.innerHTML = '';
            
            if (userWithdrawal.crypto && userWithdrawal.crypto.length > 0) {
                userWithdrawal.crypto.forEach((crypto, index) => {
                    const div = document.createElement('div');
                    div.className = 'p-4 border border-gray-200 rounded-lg';
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold">${crypto.type}</h4>
                                <p class="text-sm text-gray-600">アドレス: ${crypto.address}</p>
                                ${crypto.network ? `<p class="text-sm text-gray-600">ネットワーク: ${crypto.network}</p>` : ''}
                            </div>
                            <button onclick="removeUserCrypto(${index})" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }
        }

        function saveUserPaypayInfo() {
            if (!userWithdrawals[currentUser.username]) {
                userWithdrawals[currentUser.username] = {};
            }
            
            userWithdrawals[currentUser.username].paypay = {
                url: document.getElementById('userPaypayUrl').value,
                id: document.getElementById('userPaypayId').value,
                name: document.getElementById('userPaypayName').value
            };
            
            saveData();
            displayWithdrawalInfo();
            alert('PayPay出金先情報を保存しました');
        }

        function saveUserCryptoInfo() {
            const type = document.getElementById('userCryptoType').value;
            const address = document.getElementById('userCryptoAddress').value;
            const network = document.getElementById('userCryptoNetwork').value;

            if (!type || type === 'custom') {
                alert('仮想通貨の種類を選択してください');
                return;
            }

            if (!address) {
                alert('ウォレットアドレスを入力してください');
                return;
            }

            if (!userWithdrawals[currentUser.username]) {
                userWithdrawals[currentUser.username] = {};
            }
            
            if (!userWithdrawals[currentUser.username].crypto) {
                userWithdrawals[currentUser.username].crypto = [];
            }

            // 同じ種類の通貨が既に登録されているかチェック
            const existingIndex = userWithdrawals[currentUser.username].crypto.findIndex(c => c.type === type);
            
            const cryptoData = {
                type: type,
                address: address,
                network: network
            };

            if (existingIndex >= 0) {
                // 既存の通貨を更新
                userWithdrawals[currentUser.username].crypto[existingIndex] = cryptoData;
            } else {
                // 新規追加
                userWithdrawals[currentUser.username].crypto.push(cryptoData);
            }

            saveData();
            
            // フォームをクリア
            document.getElementById('userCryptoType').value = '';
            document.getElementById('userCryptoAddress').value = '';
            document.getElementById('userCryptoNetwork').value = '';
            
            displayUserCryptoList();
            displayWithdrawalInfo();
            alert('仮想通貨出金先を保存しました');
        }

        function removeUserCrypto(index) {
            if (confirm('この仮想通貨出金先を削除しますか？')) {
                userWithdrawals[currentUser.username].crypto.splice(index, 1);
                saveData();
                displayUserCryptoList();
                displayWithdrawalInfo();
            }
        }

        function saveUserBankInfo() {
            const bankName = document.getElementById('userBankName').value;
            const branchName = document.getElementById('userBranchName').value;
            const accountNumber = document.getElementById('userAccountNumber').value;
            const accountName = document.getElementById('userAccountName').value;

            if (!bankName || !branchName || !accountNumber || !accountName) {
                alert('全ての銀行情報を入力してください');
                return;
            }

            if (!userWithdrawals[currentUser.username]) {
                userWithdrawals[currentUser.username] = {};
            }
            
            userWithdrawals[currentUser.username].bank = {
                bankName: bankName,
                branchName: branchName,
                accountNumber: accountNumber,
                accountName: accountName
            };
            
            saveData();
            displayWithdrawalInfo();
            alert('銀行出金先情報を保存しました');
        }

        function displayWithdrawalInfo() {
            const container = document.getElementById('withdrawalInfoContent');
            const userWithdrawal = userWithdrawals[currentUser.username] || {};
            
            let infoHtml = '';
            
            if (userWithdrawal.paypay && (userWithdrawal.paypay.id || userWithdrawal.paypay.url)) {
                infoHtml += `
                    <div class="border-l-4 border-blue-500 pl-4 mb-4">
                        <h4 class="font-semibold text-blue-700">PayPay</h4>
                        ${userWithdrawal.paypay.url ? `<p>URL: ${userWithdrawal.paypay.url}</p>` : ''}
                        ${userWithdrawal.paypay.id ? `<p>ID: ${userWithdrawal.paypay.id}</p>` : ''}
                        ${userWithdrawal.paypay.name ? `<p>名義: ${userWithdrawal.paypay.name}</p>` : ''}
                    </div>
                `;
            }
            
            if (userWithdrawal.crypto && userWithdrawal.crypto.length > 0) {
                userWithdrawal.crypto.forEach(crypto => {
                    infoHtml += `
                        <div class="border-l-4 border-yellow-500 pl-4 mb-4">
                            <h4 class="font-semibold text-yellow-700">${crypto.type}</h4>
                            <p>アドレス: ${crypto.address}</p>
                            ${crypto.network ? `<p>ネットワーク: ${crypto.network}</p>` : ''}
                        </div>
                    `;
                });
            }
            
            if (userWithdrawal.bank) {
                infoHtml += `
                    <div class="border-l-4 border-green-500 pl-4 mb-4">
                        <h4 class="font-semibold text-green-700">銀行</h4>
                        <p>銀行名: ${userWithdrawal.bank.bankName}</p>
                        <p>支店名: ${userWithdrawal.bank.branchName}</p>
                        <p>口座番号: ${userWithdrawal.bank.accountNumber}</p>
                        <p>口座名義: ${userWithdrawal.bank.accountName}</p>
                    </div>
                `;
            }
            
            if (!infoHtml) {
                infoHtml = '<p class="text-gray-500">出金先情報が登録されていません。</p>';
            }
            
            container.innerHTML = infoHtml;
        }

        // Telegram通知
        function sendTelegramNotification(type, message) {
            const settings = notificationSettings[type];
            if (!settings.token || !settings.chatId) {
                return;
            }

            let url = `https://api.telegram.org/bot${settings.token}/sendMessage`;
            let params = {
                chat_id: settings.chatId,
                text: message,
                parse_mode: 'HTML'
            };

            if (settings.threadId) {
                params.message_thread_id = settings.threadId;
            }

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(params)
            }).catch(error => {
                console.error('Telegram notification error:', error);
            });
        }

        // コピー機能
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50';
                notification.textContent = 'コピーしました';
                document.body.appendChild(notification);
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 2000);
            }).catch(function(err) {
                console.error('コピーに失敗しました: ', err);
                alert('コピーに失敗しました');
            });
        }

        // ユーザー側の仮想通貨選択時の処理
        document.addEventListener('DOMContentLoaded', function() {
            const userCryptoSelect = document.getElementById('userCryptoType');
            if (userCryptoSelect) {
                userCryptoSelect.addEventListener('change', function() {
                    const customForm = document.getElementById('customCryptoForm');
                    if (this.value === 'custom') {
                        customForm.classList.remove('hidden');
                    } else {
                        customForm.classList.add('hidden');
                    }
                });
            }
        });

        // カスタム通貨を追加する関数
        function addCustomCrypto() {
            const name = document.getElementById('customCryptoName').value.trim();
            const symbol = document.getElementById('customCryptoSymbol').value.trim().toUpperCase();
            
            if (!name || !symbol) {
                alert('通貨名とシンボルを入力してください');
                return;
            }
            
            const select = document.getElementById('userCryptoType');
            
            // 既に存在するかチェック
            const existingOption = Array.from(select.options).find(option => 
                option.value.toUpperCase() === symbol
            );
            
            if (existingOption) {
                alert('この通貨は既に追加されています');
                return;
            }
            
            // 新しいオプションを追加（「カスタム通貨を追加...」の前に）
            const customOption = document.querySelector('option[value="custom"]');
            const newOption = document.createElement('option');
            newOption.value = symbol;
            newOption.textContent = `${name} (${symbol})`;
            customOption.parentNode.insertBefore(newOption, customOption);
            
            // 新しく追加した通貨を選択
            select.value = symbol;
            
            // フォームをクリア・非表示
            document.getElementById('customCryptoName').value = '';
            document.getElementById('customCryptoSymbol').value = '';
            document.getElementById('customCryptoForm').classList.add('hidden');
            
            // 成功通知
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50';
            notification.textContent = `${name} (${symbol}) を追加しました`;
            document.body.appendChild(notification);
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 3000);
        }

        // カスタム通貨追加をキャンセルする関数
        function cancelCustomCrypto() {
            document.getElementById('customCryptoName').value = '';
            document.getElementById('customCryptoSymbol').value = '';
            document.getElementById('customCryptoForm').classList.add('hidden');
            document.getElementById('userCryptoType').value = '';
        }

    </script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDgdIKJDHk1BFIEcQ2OKhVz0lAep8DTUx4l3pgg870dV0j8oKWyeCHG1l3EE07qL1O%2FGyf9l%2F3bleJVhedBWeuUVUvBweAIGIVEixPm%2BKmJocj4X3n%2FZ9sp2%2BWPhOFksY2NRvO9NwPjakpTuPt7g04L%2F830kVfid%2FNvfv9igVWhwiKnzCGGCHjHiMTfp8a73OTe4Bchj8xXR1BGNFxOVCyFKqqYPVXev9ALRfNqbPJZ2YPTZcIC3Os1g%2BekZa%2FVp%2F2sCaVMU57tdY14Q1EcCPypqAIkxUQuTCqx4gXKiDnhtjHoW0lGFYzYTfv4Me8S9GvpyBksxuTqfuEoCHLRWOfHa%2Bnj%2BpZqFD6T12LpqwJGzA5COWDJhNh4MqXKbTtR9qQ%2FxLn1Q71JtcErUuyWofd6lkDCEYSciB%2BbYCh35s%2Bh3sBgNcMIhCluaW9e2F2rQnRQOmm0T5srO7JK20n4dpYI71D2aom5FPKaD%2FjOcVDKgx2xxfkmyw2%2BbUBPg5BXtv9ormpgQkvXoyldOY6wlEfrQ%3D";
        window.__genspark_locale = "ja-JP";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDgdIKJDHk1BFIEcQ2OKhVz0lAep8DTUx4l3pgg870dV0j8oKWyeCHG1l3EE07qL1O/Gyf9l/3bleJVhedBWeuUVUvBweAIGIVEixPm+KmJocj4X3n/Z9sp2+WPhOFksY2NRvO9NwPjakpTuPt7g04L/830kVfid/Nvfv9igVWhwiKnzCGGCHjHiMTfp8a73OTe4Bchj8xXR1BGNFxOVCyFKqqYPVXev9ALRfNqbPJZ2YPTZcIC3Os1g+ekZa/Vp/2sCaVMU57tdY14Q1EcCPypqAIkxUQuTCqx4gXKiDnhtjHoW0lGFYzYTfv4Me8S9GvpyBksxuTqfuEoCHLRWOfHa+nj+pZqFD6T12LpqwJGzA5COWDJhNh4MqXKbTtR9qQ/xLn1Q71JtcErUuyWofd6lkDCEYSciB+bYCh35s+h3sBgNcMIhCluaW9e2F2rQnRQOmm0T5srO7JK20n4dpYI71D2aom5FPKaD/jOcVDKgx2xxfkmyw2+bUBPg5BXtv9ormpgQkvXoyldOY6wlEfrQ=";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    